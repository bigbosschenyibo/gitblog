# [C# å¦‚ä½•åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­è°ƒç”¨åŠå–æ¶ˆä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„åŒæ­¥æ–¹æ³•](https://github.com/bigbosschenyibo/gitblog/issues/8)

åœ¨ä¸Šä¸€ç¯‡[C# å¦‚ä½•ä¼˜é›…åœ°å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡](https://github.com/bigbosschenyibo/gitblog/issues/7) è™½ç„¶å–æ¶ˆäº†æœªç»“æŸçš„å¼‚æ­¥ä»»åŠ¡ï¼Œä½†æ˜¯è¢«è°ƒç”¨çš„åŒæ­¥æ–¹æ³•ä»æœªç»“æŸï¼›ä»£ç ä¸å¤Ÿä¼˜é›…ï¼Œæ‰€ä»¥åœ¨æŸ¥çœ‹äº†Bç«™åšä¸»çš„è¿™ä¸ª[C#å¦‚ä½•åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­è°ƒç”¨åŠå–æ¶ˆä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„åŒæ­¥æ–¹æ³•ï¼ˆå…¶ä¸€ï¼‰](https://www.bilibili.com/video/BV1im421M7if/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=9aa74cd16feeb35824d231f9694f223b)è§†é¢‘åï¼Œå‘ç°ä»–çš„åšæ³•æ¯”è¾ƒä¼˜é›…ï¼›
> **æ³¨æ„ï¼šè¿™ä¸ªğŸ‘†è§†é¢‘ä»‹ç»çš„æ–¹æ³•é€‚ç”¨äº.NET Frameworkå¹³å°ï¼Œåœ¨.NET COREå¹³å°ä¸‹å·²ç»ä¸å†é€‚ç”¨ï¼Œå¦‚æœä½ æ˜¯.NET COREå¹³å° è¯·çœ‹[C#å¦‚ä½•åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­è°ƒç”¨åŠå–æ¶ˆä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„åŒæ­¥æ–¹æ³•ï¼ˆå…¶äºŒï¼‰](https://www.bilibili.com/video/BV1Hi421U77K/?vd_source=9aa74cd16feeb35824d231f9694f223b)**

ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯.NET Frameworkå¹³å°ï¼Œæ‰€ä»¥ä¸‹é¢çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ï¼ŒğŸ‘‰è¿™ä¸ªæ˜¯åšä¸»ç»™å‡ºçš„gitsé“¾æ¥[CancelableProcessTask.cs](https://gist.github.com/BYJRK/29f10593cb6899294deb08dd972a6a27)ï¼Œç¨ç¨æ”¹å†™äº†è¿æ¥ä¸­ç»™å‡ºçš„ä»£ç ï¼Œä¾¿æœ‰äº†ä¸‹é¢çš„æ–¹æ³•

```c#
public static class CancelableThreadTask
{
    public static Task RunAsync(this Action action, CancellationToken token, Action onCompletedSuccessfully = null)
    {
        var tcs = new TaskCompletionSource<string>();
        var thread = new Thread(() =>
        {
            try
            {
                action();
                tcs.SetResult("Success");
                onCompletedSuccessfully?.Invoke();
            }
            catch (Exception ex)
            {
                if (ex is ThreadAbortException)
                {
                    tcs.TrySetCanceled();
                }
                else
                {
                    tcs.TrySetException(ex);
                }
            }
        });

        token.Register(() =>
        {
            thread.Abort();
            // _thread.Join();
            tcs.TrySetCanceled();
        });

        thread.Start();

        return tcs.Task;
    }
}
```
ä½¿ç”¨ç¤ºä¾‹ï¼š
``` c#
using System;
using System.Threading;
using System.Threading.Tasks;
using System.Windows;
using CancelableDemo;
using ThirdPartyLib;

namespace CancelableApp
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow
    {
        public MainWindow()
        {
            InitializeComponent();
        }

        private int orderNo = 1;

        private CancellationTokenSource cts = new CancellationTokenSource();

        private async void RunBtn_OnClick(object sender, RoutedEventArgs e)
        {
            try
            {
                cts.Cancel();
            }
            finally
            {
                cts.Dispose();
                cts = new CancellationTokenSource();
            }

            try
            {
                await new Action(() =>
                {
                    var o = new ThirdPartyClass();
                    // throw new Exception("--00");
                    var resp = o.LongRunningJob($"{DateTime.Now:yyyy/MM/dd HH:mm:ss}");
                }).RunAsync( cts.Token,OnComplete);
            }
            catch (TaskCanceledException ee)
            {
                Console.WriteLine("å–æ¶ˆ");
            }
            catch (Exception exception)
            {
                Console.WriteLine(exception);
            }
        }

        private void OnComplete()
        {
            Console.WriteLine("æ‰§è¡Œç»“æŸ");
        }
    }
}
```
è¿è¡Œæ•ˆæœï¼š
![å–æ¶ˆæ­£åœ¨æ‰§è¡Œä¸­çš„åŒæ­¥æ–¹æ³•](https://github.com/user-attachments/assets/8b4cb70f-5298-4b5a-92dd-94472c504475)
### æ€»ç»“ï¼Œå½“ä¸‰æ–¹APIä¸­åªç»™å‡ºäº†åŒæ­¥æ¥å£ï¼ŒåŒæ—¶è¿™ä¸ªæ¥å£è¿˜éå¸¸è€—æ—¶çš„æƒ…å†µä¸‹ï¼Œ
- å¦‚æœæƒ³å®ç°åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ï¼Œç»“æŸæ‰ä¸Šæ¬¡è¿˜æœªè¿”å›çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆ[C# å¦‚ä½•ä¼˜é›…åœ°å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡](https://github.com/bigbosschenyibo/gitblog/issues/7) è¿™ä¸ªå°±å¤Ÿäº†ï¼›
- å¦‚æœä¸ä»…æƒ³ç»“æŸæ‰æœªè¿”å›çš„ä»»åŠ¡ï¼Œè¿˜å¸Œæœ›å°†ä¸‰æ–¹APIä¸­çš„åŒæ­¥æ–¹æ³•ä¹Ÿç»“æŸæ‰ï¼Œåˆ™éœ€è¦ä½¿ç”¨åˆ°Threadæ“ä½œï¼Œåœ¨åˆ¤æ–­åˆ°å–æ¶ˆæ“ä½œåï¼Œç»“æŸæ‰å“åº”çš„threadå°±okäº†ã€‚